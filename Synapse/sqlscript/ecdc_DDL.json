{
	"name": "ecdc_DDL",
	"properties": {
		"content": {
			"query": "-- create schema\ncreate schema ecdc;\n\nIF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'ecdc_parquet_format')\n\tCREATE EXTERNAL FILE FORMAT [ecdc_parquet_format]\n\tWITH ( FORMAT_TYPE = PARQUET)\nGO\n\nIF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'ecdc_curated_ds')\n\tCREATE EXTERNAL DATA SOURCE [ecdc_curated_ds]\n\tWITH (\n\t\tLOCATION = 'https://adlsvedity.dfs.core.windows.net/curated/'\n\t)\nGO\n\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK 'https://adlsvedity.dfs.core.windows.net/curated/ecdc/cases/part-00000-8abe7eb6-7454-4ac3-9fc8-4d9bfd374c56-c000.snappy.parquet',\n        FORMAT='PARQUET'\n    ) AS [result]\n\n--drop external table [dbo].[ecdc.cases_deaths_ext]\n\nCREATE EXTERNAL TABLE [dbo].[ecdc.cases_deaths_ext]\n(\n\t[country] [varchar](8000) NULL,\n\t[continent] [varchar](8000) NULL,\n\t[source] [varchar](8000) NULL,\n\t[population] [varchar](8000) NULL,\n\t[year_week] [varchar](10) NULL,\n\t[country_code] [varchar](8000) NULL,\n\t[year] [smallint] NULL,\n\t[month] [smallint] NULL,\n    [yearMonth] [varchar](10) NULL,\n\t[cases] [bigint] NULL,\n\t[deaths] [bigint] NULL\n)\nWITH (DATA_SOURCE = [ecdc_curated_ds],LOCATION = N'ecdc/cases/*.parquet',FILE_FORMAT = [ecdc_parquet_format],REJECT_TYPE = VALUE,REJECT_VALUE = 0)\nGO\n\nCREATE TABLE [dbo].[ecdc.cases_deaths_tbl]\n(\n\t[country] [varchar](8000) NULL,\n\t[continent] [varchar](8000) NULL,\n\t[source] [varchar](8000) NULL,\n\t[population] [varchar](8000) NULL,\n\t[year_week] [varchar](10) NULL,\n\t[country_code] [varchar](8000) NULL,\n\t[year] [smallint] NULL,\n\t[month] [smallint] NULL,\n\t[yearMonth] [varchar](10) NULL,\n\t[cases] [bigint] NULL,\n\t[deaths] [bigint] NULL\n)\nWITH\n(\nCLUSTERED COLUMNSTORE INDEX,  DISTRIBUTION = HASH([country]),  PARTITION (\n[year] RANGE RIGHT FOR VALUES (\n'2019','2020', '2021')\n)\n)\nGO\n\n--select distinct year from [dbo].[ecdc.cases_deaths_tbl]\n\nCREATE VIEW [dbo].[casesDeathsView]\nAS select  country , continent,year,month, SUM(cases) AS totalCases,SUM(deaths) AS totalDeaths\nfrom [dbo].[ecdc.cases_deaths_tbl] \ngroup by country, continent,year,month\nUNION ALL\nselect  country , null as continent, null as year, null as month, SUM(cases) AS totalCases,SUM(deaths) AS totalDeaths\nfrom [dbo].[ecdc.cases_deaths_tbl]  \ngroup by country\nUNION ALL\nselect  null as country , continent, null as year, null as month, SUM(cases) AS totalCases,SUM(deaths) AS totalDeaths\nfrom [dbo].[ecdc.cases_deaths_tbl]  \ngroup by continent\nUNION ALL\nselect  null as country , null as continent, year, null as month, SUM(cases) AS totalCases,SUM(deaths) AS totalDeaths\nfrom [dbo].[ecdc.cases_deaths_tbl]  \ngroup by year\nUNION ALL\nselect  null as country , null as continent, null as year, month, SUM(cases) AS totalCases,SUM(deaths) AS totalDeaths\nfrom [dbo].[ecdc.cases_deaths_tbl]  \ngroup by month;\nGO\n\n\nCREATE TABLE [dbo].[casesDeaths_cube]\n(\n\t[country] [varchar](8000) NULL,\n\t[continent] [varchar](8000) NULL,\n\t[year] [smallint] NULL,\n\t[month] [smallint] NULL,\n\t[totalCases] [bigint] NULL,\n\t[totalDeaths] [bigint] NULL,\n\t[yearMonth] [varchar](13) NOT NULL\n)\nWITH\n(\n\tDISTRIBUTION = ROUND_ROBIN,\n\tCLUSTERED COLUMNSTORE INDEX\n)\nGO\n\n\n\n\nCREATE PROC [dbo].[ecdc.covid19_external_cases_to_db_prc] AS\n\nBEGIN\n/**********************************************************************************************\n   NAME     :  [ecdc.covid19_external_cases_to_db_prc]\n   PURPOSE  :  This sp is used to populate ecdc_covid_cases tables from external tables.\n   REVISIONS:\n   Ver        Date\t\t\tAuthor                    Description\n   ---------  ----------\t\t---------------\t\t------------------------------------\n   1.0        02-Sep-2021\t\tMehul                Initial Version.\n\n--EXEC [ecdc.covid19_external_cases_to_db_prc] \n\n**********************************************************************************************/  \nDECLARE\n@ldate date,\n@lcount bigint,\n@lerror varchar(max);\n\nBEGIN TRY\n\nselect   @lcount = count(*)  from  [dbo].[ecdc.cases_deaths_tbl];\n        \nIF @lcount>0 \nBEGIN\ndelete from  [dbo].[ecdc.cases_deaths_tbl];\nEND;\n\ninsert into [dbo].[ecdc.cases_deaths_tbl]\nselect * from  ecdc.cases_deaths_ext where country not like '%total%'\n\nEND TRY\nBEGIN CATCH\nSELECT @lerror = Error_Message()\nselect @lerror as errorMessage\nEND CATCH\n\nBEGIN TRY\n\nselect   @lcount = count(*)  from  [dbo].[ecdc.casesDeaths_cube];\n        \nIF @lcount>0 \nBEGIN\ndelete from  [dbo].[ecdc.casesDeaths_cube];\nEND;\n\ninsert into [dbo].[ecdc.casesDeaths_cube]\nSELECT a.*,concat(year,'-',month) yearMonth FROM casesDeathsView a;\n\nEND TRY\nBEGIN CATCH\nSELECT @lerror = Error_Message()\nselect @lerror as errorMessage\nEND CATCH\n\nEND;\nGO\n\n\nCREATE EXTERNAL TABLE [dbo].[ecdc.hospitals_icus_ext]\n(\n\t[country] [varchar](8000) NULL,\n\t[year_week] [varchar](10) NULL,\n\t[source] [varchar](8000) NULL,\n\t[url] [varchar](8000) NULL,\n\t[year] [smallint] NULL,\n\t[months] [smallint] NULL,\n\t[date] [date] NULL,\n\t[icu_count] [float] NULL,\n\t[hospital_count] [float] NULL\n)\nWITH (DATA_SOURCE = [ecdc_curated_ds],LOCATION = N'ecdc/hospitals/*.parquet',FILE_FORMAT = [ecdc_parquet_format],REJECT_TYPE = VALUE,REJECT_VALUE = 0)\nGO\n\nCREATE TABLE [dbo].[ecdc.hospitals_icus_tbl]\n(\n\t[country] [varchar](8000) NULL,\n\t[year_week] [varchar](10) NULL,\n\t[source] [varchar](8000) NULL,\n\t[url] [varchar](8000) NULL,\n\t[year] [smallint] NULL,\n\t[months] [smallint] NULL,\n\t[date] [date] NULL,\n\t[icu_count] [float] NULL,\n\t[hospital_count] [float] NULL\n)\nWITH\n(\nCLUSTERED COLUMNSTORE INDEX,  DISTRIBUTION = HASH([country]),  PARTITION (\n[year] RANGE RIGHT FOR VALUES (\n'2019','2020', '2021')\n)\n)\nGO\n\n\n\nCREATE PROC [dbo].[ecdc.covid19_external_hospitals_to_db_prc] AS\n\nBEGIN\n/**********************************************************************************************\n   NAME     :  [ecdc.covid19_external_hospitals_to_db_prc]\n   PURPOSE  :  This sp is used to populate ecdc_covid_cases tables from external tables.\n   REVISIONS:\n   Ver        Date\t\t\tAuthor                    Description\n   ---------  ----------\t\t---------------\t\t------------------------------------\n   1.0        02-Sep-2021\t\tMehul                Initial Version.\n\n--EXEC [ecdc.covid19_external_hospitals_to_db_prc] \n\n**********************************************************************************************/  \nDECLARE\n@ldate date,\n@lcount bigint,\n@lerror varchar(max);\n\nBEGIN TRY\n\nselect   @lcount = count(*)  from  [dbo].[ecdc.hospitals_icus_tbl];\n        \nIF @lcount>0 \nBEGIN\ndelete from  [dbo].[ecdc.hospitals_icus_tbl];\nEND;\n\ninsert into [dbo].[ecdc.hospitals_icus_tbl]\nselect * from  ecdc.hospitals_icus_ext;\n\nEND TRY\nBEGIN CATCH\nSELECT @lerror = Error_Message()\nselect @lerror as errorMessage\nEND CATCH\n\nEND;\nGO\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "poc_sqldw",
				"poolName": "poc_sqldw"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}